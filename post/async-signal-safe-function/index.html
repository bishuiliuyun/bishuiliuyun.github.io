<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>异步信号安全函数 - Even - A super concise theme for Hugo</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="None"><meta name=description content="异步信号安全函数 在学习redis的src/server.c时发现输出日志居然在实现了serverLogRaw()时又实现了下述函数并使用更底"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.62.2 with theme even"><link rel=canonical href=http://localhost:1313/post/async-signal-safe-function/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="异步信号安全函数"><meta property="og:description" content="异步信号安全函数 在学习redis的src/server.c时发现输出日志居然在实现了serverLogRaw()时又实现了下述函数并使用更底"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/async-signal-safe-function/"><meta property="article:published_time" content="2020-02-29T23:28:38+08:00"><meta property="article:modified_time" content="2020-02-29T23:28:38+08:00"><meta itemprop=name content="异步信号安全函数"><meta itemprop=description content="异步信号安全函数 在学习redis的src/server.c时发现输出日志居然在实现了serverLogRaw()时又实现了下述函数并使用更底"><meta itemprop=datePublished content="2020-02-29T23:28:38+08:00"><meta itemprop=dateModified content="2020-02-29T23:28:38+08:00"><meta itemprop=wordCount content="907"><meta itemprop=keywords content="Development,System,"><meta name=twitter:card content="summary"><meta name=twitter:title content="异步信号安全函数"><meta name=twitter:description content="异步信号安全函数 在学习redis的src/server.c时发现输出日志居然在实现了serverLogRaw()时又实现了下述函数并使用更底"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>None的学习笔记</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>主页</li></a><a href=/post/><li class=mobile-menu-item>归档</li></a><a href=/tags/><li class=mobile-menu-item>标签</li></a><a href=/categories/><li class=mobile-menu-item>分类</li></a><a href=/series/><li class=mobile-menu-item>系列</li></a><a href=/about/><li class=mobile-menu-item>关于</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>None的学习笔记</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>主页</a></li><li class=menu-item><a class=menu-item-link href=/post/>归档</a></li><li class=menu-item><a class=menu-item-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-item-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-item-link href=/series/>系列</a></li><li class=menu-item><a class=menu-item-link href=/about/>关于</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>异步信号安全函数</h1><div class=post-meta><span class=post-time>2020-02-29</span><div class=post-category><a href=/categories/development/>Development</a>
<a href=/categories/system/>System</a></div></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#异步信号安全函数>异步信号安全函数</a></li></ul></li></ul></nav></div></div><div class=post-content><h3 id=异步信号安全函数>异步信号安全函数</h3><p>在学习redis的src/server.c时发现输出日志居然在实现了serverLogRaw()时又实现了下述函数并使用更底层的系统调用write去写日志：</p><p>通过<code>man signal-safety</code>可以查看对于信号安全、异步信号安全的函数:</p><p>An async-signal-safe function is one that can be safely called from within a signal handler. Many functions are not async-signal-safe. In particular, non-reentrant functions are generally unsafe to call from a signal handler.</p><p>The kinds of issues that render a function unsafe can be quickly understood when one considers the implementation of the stdio library, all of whose functions are not async-signal-safe.</p><p>When performing buffered I/O on a file, the stdio functions must maintain a statically allocated data buffer along with associated counters and indexes (or pointers) that record the amount of data and the current position in the buffer. Suppose that the main program is in the middle of a call to a stdio function such as printf(3) where the buffer and associated variables have been partially updated. If, at that moment, the program is interrupted by a signal handler that also calls printf(3), then the second call to printf(3) will operate on inconsistent data, with unpredictable results.</p><p>To avoid problems with unsafe functions, there are two possible choices:</p><p>1.Ensure that (a) the signal handler calls only async-signal-safe functions, and (b) the signal handler itself is reentrant with respect to global variables in the main program.</p><p>2.Block signal delivery in the main program when calling functions that are unsafe or operating on global data that is also accessed by the signal handler.</p><p>Generally, the second choice is difficult in programs of any complexity, so the first choice is taken.</p><p>POSIX.1 specifies a set of functions that an implementation must make async-signal-safe. (An implementation may provide safe implementations of additional functions, but this is not required by the standard and other implementations may not provide the same guarantees.) In general, a function is async-signal-safe either because it is reentrant or because it is atomic with respect to signals (i.e., its execution can't be interrupted by a signal handler).</p><p>The set of functions required to be async-signal-safe by POSIX.1 is shown in the following table. The functions not otherwise noted were required to be async-signal-safe in POSIX.1-2001; the table details changes in the subsequent standards.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
Function               Notes
abort(3)               Added in POSIX.1-2003
accept(2)
bind(2)
getgid(2)
......
write(2)
</code></pre></td></tr></table></div></div><p>通过注释我们发现该函数主要是在信号(那些从Redis角度来看不是致命的信号)处理函数中被调用，对于能够杀死Redis进程的信号调用serverLog()函数。
通过Google我们发现:</p><p>异步信号安全函数是可以从信号处理函数中可以安全调用的函数。许多函数不是异步信号安全的，特别是非重入函数通常从信号处理函数中调用是不安全的。
当人们考虑使用stdio库的实现时，可以很快理解函数不安全的各种问题，因为stdio库的所有函数都不是异步信号安全的。
当对文件执行缓冲的I/O时，stdio函数必须维护一个静态分配的数据缓冲区以及相关的计数器和索引（或指针），这些计数器和索引记录数据量和缓冲区中的当前位置。假设主程序在对stdio函数（例如printf（3））的调用中，缓冲区和相关变量已部分更新。如果在那一刻，该程序被也调用printf（3）的信号处理程序中断，则对printf（3）的第二次调用将对不一致的数据进行操作，结果无法预测。</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>None</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-02-29</span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/development/>Development</a>
<a href=/tags/system/>System</a></div><nav class=post-nav><a class=next href=/post/c_write_log/><span class="next-text nav-default">Redis输出日志</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:your@email.com class="iconfont icon-email" title=email></a><a href=http://localhost:1313/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2017 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>None</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/dist/even.26188efa.min.js></script></body></html>